---
const {
  lat,
  lng,
  height = "400px",
  title = "Location",
  markers = []
} = Astro.props;

const allMarkers = [];

if (lat && lng) {
  allMarkers.push({ name: title, lat, lng });
}

markers.forEach(m => {
  if (m.lat && m.lng) {
    allMarkers.push(m);
  }
});
---

<div
  class="city-map w-full rounded-2xl overflow-hidden border dark:border-slate-700"
  style={`height:${height}`}
  data-lat={lat}
  data-lng={lng}
  data-markers={JSON.stringify(allMarkers)}
></div>

<script client:load>
(function () {
  const container = document.currentScript.previousElementSibling;

  if (!container) return;

  function waitForLeaflet(cb) {
    if (window.L && window.L.markerClusterGroup) {
      cb();
      return;
    }
    const t = setInterval(() => {
      if (window.L && window.L.markerClusterGroup) {
        clearInterval(t);
        cb();
      }
    }, 50);
  }

  const observer = new IntersectionObserver(
    (entries) => {
      if (!entries[0].isIntersecting) return;
      observer.disconnect();

      waitForLeaflet(() => {
        const lat = parseFloat(container.dataset.lat);
        const lng = parseFloat(container.dataset.lng);
        const markers = JSON.parse(container.dataset.markers || "[]");

        const isDark = document.documentElement.classList.contains("dark");

        const tileUrl = isDark
          ? "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png"
          : "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png";

        const map = L.map(container).setView([lat, lng], 13);

        L.tileLayer(tileUrl, {
          attribution: "© OpenStreetMap, © CartoDB"
        }).addTo(map);

        // ---------------------------
        // GOOGLE MAPS LEAFLET CONTROL
        // ---------------------------
        const GoogleMapsControl = L.Control.extend({
          options: { position: "topright" },

          onAdd: function () {
            const el = L.DomUtil.create(
              "a",
              "leaflet-control bg-white/90 dark:bg-slate-800 px-3 py-1.5 text-xs font-medium rounded-lg shadow"
            );

            el.href = `https://www.google.com/maps?q=${lat},${lng}`;
            el.target = "_blank";
            el.innerHTML = "Open in Google Maps →";

            L.DomEvent.disableClickPropagation(el);
            return el;
          }
        });

        map.addControl(new GoogleMapsControl());

        // ---------------------------
        // MARKER CLUSTERING
        // ---------------------------
        const cluster = L.markerClusterGroup();

        markers.forEach(m => {
          cluster.addLayer(
            L.marker([m.lat, m.lng]).bindPopup(m.name)
          );
        });

        map.addLayer(cluster);
      });
    },
    { threshold: 0.15 }
  );

  observer.observe(container);
})();
</script>
