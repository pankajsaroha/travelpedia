---
const { lat, lng, places, height = "400px" } = Astro.props;

// Build marker list
const allMarkers = [];

// Main city location
allMarkers.push({ name: places.title, lat, lng });

// Best places
places.placeCoords?.forEach((p) => allMarkers.push(p));

// Hidden places
places.hiddenPlacesCoords?.forEach((p) => allMarkers.push(p));
---

<div
  id="city-map"
  class="rounded-2xl shadow-xl border dark:border-slate-700 overflow-hidden"
  style={`height:${height}`}>
</div>

<script client:load define:vars={{ allMarkers }}>
  const interval = setInterval(() => {
    if (!window.L) return;

    const mapBox = document.getElementById("city-map");
    if (!mapBox) return;

    clearInterval(interval);

    const L = window.L;

    // PREMIUM CARTO VOYAGER TILES
    const lightTiles =
      "https://basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png";
    const darkTiles =
      "https://basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png";

    const isDark = document.documentElement.classList.contains("dark");

    // Create map
    const map = L.map("city-map", { zoomControl: false });

    // Set initial center BEFORE adding layers
    map.setView([allMarkers[0].lat, allMarkers[0].lng], 13);

    // Add tile layer
    L.tileLayer(isDark ? darkTiles : lightTiles, {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap | Carto",
    }).addTo(map);

    // PREMIUM CIRCLE MARKER ICON
    const pinIcon = L.icon({
      iconUrl: "/images/pin-premium.png",
      iconRetinaUrl: "/images/pin-premium@2x.png",
      iconSize: [36, 36],
      iconAnchor: [18, 36],
      popupAnchor: [0, -26],
      className: "premium-marker"
    });

    const bounds = [];

    allMarkers.forEach((loc) => {
      const marker = L.marker([loc.lat, loc.lng], { icon: pinIcon }).addTo(map);

      marker.bindPopup(`
        <div style="font-weight:600; margin-bottom:4px;">${loc.name}</div>
        <a href="https://www.google.com/maps?q=${loc.lat},${loc.lng}"
           target="_blank"
           class="text-accent underline">
           Open in Google Maps
        </a>
      `);

      bounds.push([loc.lat, loc.lng]);

      // Small entrance animation
      setTimeout(() => {
        if (marker._icon) {
          marker._icon.style.transition = "transform 0.25s ease";
          marker._icon.style.transform = "scale(1.2)";
          setTimeout(() => {
            marker._icon.style.transform = "scale(1)";
          }, 200);
        }
      }, 80);
    });

    // Fit all markers
    if (bounds.length > 1) {
      map.flyToBounds(bounds, { padding: [60, 60], duration: 1.2 });
    } else {
      map.setView(bounds[0], 13);
    }
  }, 120);
</script>

<style>
  /* Circle pin glow when hovered */
  .premium-marker:hover {
    filter: drop-shadow(0px 0px 6px #0ea5a4aa);
  }
</style>

<style>
.premium-marker {
  transition: filter 0.25s ease, transform 0.25s ease;
}

.premium-marker:hover {
  filter: drop-shadow(0 0 8px #0ea5a4aa);
  transform: scale(1.05);
}
</style>

