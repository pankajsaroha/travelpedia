---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Breadcrumbs from "../../components/Breadcrumbs.astro";
import CityMap from "../../components/CityMap.astro";
import PlaceCarousel from "../../components/PlaceCarousel.astro";
import TopPlacesGrid from "../../components/TopPlacesGrid.astro";
import CityQuickFacts from "../../components/CityQuickFacts.astro";

// SSG
export async function getStaticPaths() {
  const allCities = Object.values(
    import.meta.glob('../../content/cities/*.md', { eager: true })
  ).map((m) => m.frontmatter);

  return allCities.map((city) => ({
    params: { slug: city.slug },
    props: { city }
  }));
}

const { city } = Astro.props;

const pageTitle = `${city.title} — Travelpedia`;
const pageDesc = city.excerpt || `${city.title} travel guide`;
const heroImage = city.image || "/images/placeholder-1.svg";

const galleryImages = city.imageGallery?.length
  ? city.imageGallery
  : [heroImage];
---

<BaseLayout title={pageTitle} description={pageDesc}>

  <!-- HERO -->
  <section class="w-full rounded-2xl overflow-hidden shadow-lg mb-12">
    <swiper-container
      class="w-full h-72 md:h-96"
      autoplay="true"
      loop="true"
      speed="700"
    >
      {galleryImages.map((img) => (
        <swiper-slide>
          <div class="relative w-full h-72 md:h-96">
            <img
              src={img}
              alt={city.title}
              class="w-full h-full object-cover transition-transform duration-700 hero-zoom"
            />
            <div class="absolute inset-x-0 bottom-0 h-32 bg-gradient-to-t from-black/60 to-transparent"></div>
          </div>
        </swiper-slide>
      ))}
    </swiper-container>
  </section>

  <!-- TITLE -->
  <section class="mb-12">
    <Breadcrumbs trail={[
      { label: "Home", href: "/" },
      { label: city.state, href: `/state/${city.state}` },
      { label: city.title, href: "" }
    ]} />

    <h1 class="text-4xl font-extrabold mt-4">{city.title}</h1>

    <p class="mt-3 text-lg text-slate-600 dark:text-slate-300 max-w-3xl">
      {city.excerpt}
    </p>
  </section>

  <!-- PAGE LAYOUT -->
  <div class="grid md:grid-cols-3 gap-12">

    <!-- MAIN -->
    <main class="md:col-span-2 space-y-20">

      <!-- TOP PLACES -->
      <TopPlacesGrid
        title="Top Places to Visit"
        places={city.bestPlaces?.slice(0, 6)}
      />

      <!-- HIDDEN GEMS -->
      {city.hiddenPlaces?.length > 0 && (
        <PlaceCarousel
          title="Hidden Gems"
          places={city.hiddenPlaces}
        />
      )}

      <!-- MAP OVERVIEW -->
      {city.lat && city.lng && (
        <section>
          <h2 class="text-2xl font-bold mb-4">City Overview</h2>
          <CityMap lat={city.lat} lng={city.lng} title={city.title} height="360px" />
        </section>
      )}

      <!-- CTA -->
      <a
        href={`/city/${city.slug}/places`}
        class="inline-block text-accent font-semibold"
      >
        View all places in {city.title} →
      </a>

    </main>

    <!-- SIDEBAR -->
    <aside class="space-y-10">
      <CityQuickFacts city={city} />
    </aside>

  </div>

  <!-- SWIPER -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-element-bundle.min.js" client:load></script>

  <style>
    swiper-slide:hover .hero-zoom {
      transform: scale(1.05);
    }
  </style>

</BaseLayout>
