---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Breadcrumbs from "../../components/Breadcrumbs.astro";
import CityMap from "../../components/CityMap.astro";
import PlaceCarousel from "../../components/PlaceCarousel.astro";
import CityQuickFacts from "../../components/CityQuickFacts.astro";
import CitySimpleList from "../../components/CitySimpleList.astro";
import CityInfoCards from "../../components/CityInfoCards.astro";
import LocalInsight from "../../components/LocalInsight.astro";

// SSG
export async function getStaticPaths() {
  const allCities = Object.values(
    import.meta.glob('../../content/cities/*.md', { eager: true })
  ).map((m) => m.frontmatter);

  return allCities.map((city) => ({
    params: { slug: city.slug },
    props: { city }
  }));
}

const { city } = Astro.props;

const pageTitle = `${city.title} — Travelpedia`;
const pageDesc = city.excerpt || `${city.title} travel guide`;
const heroImage = city.image || "/images/placeholder-1.svg";

const galleryImages = city.imageGallery?.length
  ? city.imageGallery
  : [heroImage];
---

<BaseLayout title={pageTitle} description={pageDesc}>

  <!-- HERO -->
  <section class="w-full rounded-2xl overflow-hidden shadow-lg mb-12">
    <swiper-container
      class="w-full h-72 md:h-96"
      autoplay="true"
      loop="true"
      speed="700"
    >
      {galleryImages.map((img) => {
        const isProd = import.meta.env.PROD;
        const heroSrc = isProd
          ? `/cdn-cgi/image/width=1200,quality=80,format=auto/${encodeURIComponent(img)}`
          : img;

        return (
          <swiper-slide>
            <div class="relative w-full h-72 md:h-96">
              <img
                src={heroSrc}
                width="1200"
                height="600"
                loading="eager"
                fetchpriority="high"
                alt={city.title}
                class="w-full h-full object-cover transition-transform duration-700 hero-zoom"
              />
              <div class="absolute inset-x-0 bottom-0 h-32 bg-gradient-to-t from-black/60 to-transparent"></div>
            </div>
          </swiper-slide>
        );
      })}
    </swiper-container>
  </section>


  <!-- TITLE -->
  <section class="mb-12">
    <Breadcrumbs trail={[
      { label: "Home", href: "/" },
      { label: city.state, href: `/state/${city.state}` },
      { label: city.title, href: "" }
    ]} />

    <h1 class="text-4xl font-extrabold mt-4">{city.title}</h1>

    <p class="mt-3 text-lg text-slate-600 dark:text-slate-300 max-w-3xl">
      {city.excerpt}
    </p>
  </section>

  <!-- PAGE LAYOUT -->
  <div class="grid md:grid-cols-3 gap-12">

    <!-- MAIN -->
    <main class="md:col-span-2 space-y-20">

      <!-- TOP PLACES -->
      <section class="space-y-6">
        <h2 class="text-3xl font-extrabold text-slate-900 dark:text-white">
          Top Places to Visit in {city.title}
        </h2>

        <PlaceCarousel
          title={null}
          places={city.bestPlaces}
        />
      </section>

      <!-- HIDDEN GEMS -->
      {city.hiddenPlaces?.length > 0 && (
        <section class="space-y-4">
          <h2 class="text-xl font-semibold text-slate-700 dark:text-slate-300">
            Hidden Gems
          </h2>

          <PlaceCarousel
            title={null}
            places={city.hiddenPlaces}
          />
        </section>
      )}

      {city.thingsToDo && (
        <CitySimpleList title="Things To Do" items={city.thingsToDo} />
      )}

      {city.bestTime && (
        <CityInfoCards title="Best Time to Visit" data={city.bestTime} />
      )}

      {city.idealStay && (
        <CityInfoCards title="Ideal Stay Duration" data={city.idealStay} />
      )}

      {city.budget && (
        <CityInfoCards title="Budget Overview" data={city.budget.summary} />
      )}

      {city.food && (
        <CitySimpleList title="What to Eat" items={city.food} />
      )}

      {city.tips && (
        <CitySimpleList title="Important Tips" items={city.tips} />
      )}

      {city.localInsight && (
        <LocalInsight
          title={city.localInsight.title}
          tip={city.localInsight.tip}
        />
      )}


      <!-- MAP OVERVIEW -->
      {city.lat && city.lng && (
        <section>
          <h2 class="text-2xl font-bold mb-4">City Overview</h2>
          <CityMap lat={city.lat} lng={city.lng} title={city.title} height="360px" />
        </section>
      )}

      <!-- CTA -->
      <!--<a
        href={`/city/${city.slug}/places`}
        class="inline-block text-accent font-semibold"
      >
        View all places in {city.title} →
      </a> -->

    </main>

    <!-- SIDEBAR -->
    <aside class="space-y-10">
      <CityQuickFacts city={city} />
    </aside>

  </div>

  <!-- SWIPER -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-element-bundle.min.js" client:load></script>

  <style>
    swiper-slide:hover .hero-zoom {
      transform: scale(1.05);
    }
  </style>

</BaseLayout>
