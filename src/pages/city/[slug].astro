---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Breadcrumbs from '../../components/Breadcrumbs.astro';
import CityMap from '../../components/CityMap.astro';
import Gallery from "../../components/Gallery.astro";

// Load all cities for SSG
export async function getStaticPaths() {
  const allCities = Object.values(
    import.meta.glob('../../content/cities/*.md', { eager: true })
  ).map((m) => m.frontmatter);

  return allCities.map((city) => ({
    params: { slug: city.slug },
    props: { city },
  }));
}

const { city } = Astro.props;

// SEO metadata
const pageTitle = `${city.title} â€” Travelpedia`;
const pageDesc = city.excerpt || `${city.title} travel guide: history, places, hotels & more`;
const heroImage = city.image || "/images/placeholder-1.jpg";

// For image gallery (fallback to hero image)
const gallery = city.gallery?.length > 0 ? city.gallery : [heroImage];

// For nearby places
const nearby = [
  ...(city.bestPlaces || []),
  ...(city.hiddenPlaces || [])
];
---

<BaseLayout title={pageTitle} description={pageDesc}>

  <!-- BREADCRUMBS -->
  <Breadcrumbs trail={[
    { label: 'Home', href: '/' },
    { label: city.state, href: `/state/${city.state}` },
    { label: city.title, href: '' }
  ]} />

  <!-- HERO IMAGE -->
  <section>
    <div class="w-full h-64 rounded-lg overflow-hidden">
      <img src={heroImage} alt={city.title} class="w-full h-full object-cover" />
    </div>
    <h1 class="text-3xl font-bold mt-4">{city.title}</h1>
    <p class="text-slate-600 mt-1">{city.state}</p>
    <p class="mt-3 text-slate-700 text-lg">{city.excerpt}</p>
  </section>

  <!-- GRID LAYOUT -->
  <div class="grid md:grid-cols-3 gap-8 mt-8">

    <!-- LEFT COLUMN (MAIN CONTENT) -->
    <main class="md:col-span-2 space-y-8">

      <!-- HISTORY -->
      <article>
        <h2 class="text-2xl font-semibold mb-2">History</h2>
        <p class="text-slate-700 leading-relaxed">{city.history}</p>
      </article>

      <!-- BEST PLACES -->
      <article>
        <h2 class="text-2xl font-semibold mb-2">Top Places to Visit</h2>
        <ul class="list-disc pl-6 space-y-1 text-slate-700">
          {city.bestPlaces?.map((p) => <li>{p}</li>)}
        </ul>
      </article>

      <!-- IMAGE GALLERY -->
      <article>
        <h2 class="text-2xl font-semibold mb-3">Image Gallery</h2>
        <Gallery images={gallery} />
      </article>

    <section class="mt-8">
    <h2 class="text-2xl font-semibold mb-3">Map</h2>

    {city.lat && city.lng ? (
      <CityMap
        lat={city.lat}
        lng={city.lng}
        places={city}
        height="350px"
      />
    ) : (
      <p class="text-sm text-slate-500">
        Map coordinates unavailable.
      </p>
    )}
    </section>


      <!-- NEARBY PLACES -->
      <article>
        <h2 class="text-2xl font-semibold mb-2">Nearby Recommended Places</h2>
        <ul class="list-disc pl-6 space-y-1 text-slate-700">
          {nearby.map((p) => <li>{p}</li>)}
        </ul>
      </article>

    </main>

    <!-- RIGHT COLUMN (SIDEBAR) -->
    <aside class="space-y-6">

      <!-- DISTANCES -->
      <section class="border rounded-lg p-4 shadow-sm bg-white">
        <h3 class="text-xl font-semibold mb-2">Distances</h3>
        <p class="text-sm text-slate-700">Airport: {city.distances?.airport}</p>
        <p class="text-sm text-slate-700">Railway: {city.distances?.railway}</p>
        <p class="text-sm text-slate-700">Bus Station: {city.distances?.bus}</p>
      </section>

      <!-- HOTELS -->
      <section class="border rounded-lg p-4 shadow-sm bg-white">
        <h3 class="text-xl font-semibold mb-3">Best Hotels</h3>
        <div class="space-y-3">
          {city.bestHotels?.map((h) => (
            <div class="p-3 border rounded-lg hover:shadow transition">
              <div class="font-medium">{h.name}</div>
              <div class="text-sm text-slate-600">{h.price}</div>
              <a class="text-sm text-accent hover:underline mt-1 block" href={h.link || "#"}>
                View details
              </a>
            </div>
          ))}
        </div>
      </section>

      <!-- HOW TO REACH -->
      <section class="border rounded-lg p-4 shadow-sm bg-white">
        <h3 class="text-xl font-semibold mb-2">How to Reach</h3>
        <p class="text-sm text-slate-700 leading-relaxed">{city.howToReach}</p>
      </section>

    </aside>

  </div>

<!-- Load Leaflet globally -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<script is:inline>
  const script = document.createElement("script");
  script.src = "https://unpkg.com/leaflet@1.9.4/dist/leaflet.js";
  script.onload = () => console.log("Leaflet loaded globally");
  document.body.appendChild(script);
</script>


</BaseLayout>
